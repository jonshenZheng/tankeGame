function giftBaseClass(e){"[object Object]"!==Object.prototype.toString.call(e)&&(e={});var t,i={},l=this;i.width=e.width||50,i.height=e.height||50,i.loc_x=e.loc_x||0,i.loc_y=e.loc_y||0,i.giftType=e.giftType||"buller",i.powerType=e.powerType||2,i.bullerNum=e.bullerNum||80,i.color=e.color||"#000",i.stroke=e.stroke||!0,i.text=e.text||"",this.width=i.width,this.height=i.height,this.loc_x=i.loc_x,this.loc_y=i.loc_y,this.giftType=i.giftType,"buller"===i.giftType&&(this.powerType=i.powerType,this.bullerNum=i.bullerNum),this.appearance={color:i.color,stroke:i.stroke,text:i.text},t=function(){gift_list[gift_list.length]=l,getLocation(l)}()}function gift_buller_power1(){giftBaseClass.call(this,{powerType:1,text:"power1"})}function gift_buller_power2(){giftBaseClass.call(this,{powerType:2,text:"power2",bullerNum:3})}function gift_buller_power3(){giftBaseClass.call(this,{powerType:3,text:"power3",bullerNum:2})}function makeGift(e){switch(e){case"gift_buller_power1":return new gift_buller_power1;case"gift_buller_power2":return new gift_buller_power2;case"gift_buller_power3":return new gift_buller_power3}}function buller(e){var t,i,l={};t=arguments.callee.caller,t&&(i=getFunctionName(String(t)),equipment_list[i]||(equipment_list[i]=i)),"[object Object]"!==Object.prototype.toString.call(e)&&(e={}),l.power=e.power||1,l.speed=e.speed||20,l.loc_x=e.loc_x||0,l.loc_y=e.loc_y||0,l.getShapWid=e.getShapWid||4,l.getShapHei=e.getShapHei||4,l.shootShapWid=e.shootShapWid||4,l.shootShapHei=e.shootShapHei||4,l.ownerName=e.ownerName||"",l.deration=e.deration||0,this.power=l.power,this.speed=l.speed,this.loc_x=l.loc_x,this.loc_y=l.loc_y,this.ownerName=l.ownerName,this.deration=l.deration,l.shootShapWid<l.shootShapHei&&(l.shootShapWid=l.shootShapHei),this.shootShap={wid:l.shootShapWid,hei:l.shootShapHei},this.__proto__=buller.prototype,this.addEquipmentType=function(){},this.buller_init_proto||(buller.prototype.buller_init_proto=!0,buller.prototype.say=function(){console.log("ok")})}function buller_0(e,t,i,l){buller.call(this,{loc_x:e,loc_y:t,ownerName:i,deration:l})}function buller_1(e,t,i,l){buller.call(this,{power:2,loc_x:e,loc_y:t,ownerName:i,deration:l})}function buller_2(e,t,i,l){buller.call(this,{power:3,loc_x:e,loc_y:t,ownerName:i,deration:l,speed:24})}function buller_3(e,t,i,l){buller.call(this,{power:4,loc_x:e,loc_y:t,ownerName:i,deration:l,speed:24})}function getBuller(e,t,i,l,o){switch(e){case 0:return new buller_0(t,i,l,o);case 1:return new buller_1(t,i,l,o);case 2:return new buller_2(t,i,l,o);case 3:return new buller_3(t,i,l,o)}}function getIdNum(e){var t=String((new Date).getTime()),i=-e||-5;return t.slice(i)}function tanke(){this.tankeName="",this.speed=10,this.color="#000",this.width=40,this.height=40,this.blood=20,this.loc_x=0,this.loc_y=0,this.emitter={color:"#000",wid:4,hei:10,x:0,y:0,deration:getRandom()%4},this.buller={type:0,num:"unlimited"},this.setName=function(){this.tankeName="tanke"+getRandom()+getIdNum()},this.joinList=function(){tanke_list[tanke_list.length]=this},this.width<this.height&&(this.width=this.height);!function(e){e.setName(),e.joinList()}(this)}function drawBG(){var e=new Image;e.src="images/gameBg.jpg",canvas_st.drawImage(e,0,0),canvas_st.save()}function getRandom(e){var t=e||parseInt(100*Math.random()*Math.random()*100);return t}function getLocation(e){e.loc_x=getRandom()%canvas_wid,e.loc_y=getRandom()%canvas_hei,checkArea(e)}function stopRecover(){}function drawEmitter(e){var t,i=e.emitter.deration;switch(canvas_st.fillStyle=e.emitter.color,i){case 0:e.emitter.x=e.loc_x-e.emitter.hei,e.emitter.y=e.loc_y+Math.floor((e.height-e.emitter.wid)/2),e.emitter.deration=0,canvas_st.fillRect(e.emitter.x,e.emitter.y,e.emitter.hei,e.emitter.wid);break;case 1:e.emitter.x=e.loc_x+Math.floor((e.width-e.emitter.wid)/2),e.emitter.y=e.loc_y-e.emitter.hei,e.emitter.deration=1,canvas_st.fillRect(e.emitter.x,e.emitter.y,e.emitter.wid,e.emitter.hei);break;case 2:t=e.loc_x+e.width,e.emitter.x=t+e.emitter.hei,e.emitter.y=e.loc_y+Math.floor((e.height-e.emitter.wid)/2),e.emitter.deration=2,canvas_st.fillRect(t,e.emitter.y,e.emitter.hei,e.emitter.wid);break;case 3:e.emitter.x=e.loc_x+Math.floor((e.width-e.emitter.wid)/2),t=e.loc_y+e.height,e.emitter.y=t+e.emitter.hei,e.emitter.deration=3,canvas_st.fillRect(e.emitter.x,t,e.emitter.wid,e.emitter.hei)}}function drawBlood(e){for(var t=e.blood,i=e.loc_x,l=e.loc_y+e.height+5,o=1,a=1,r=4,n=4;t--;)canvas_st.fillStyle="#a8e4a7",canvas_st.fillRect(i,l,r,n),t>1&&(canvas_st.fillStyle="#ddd",canvas_st.fillRect(i+r,l,o,a)),i=i+r+o}function drawTanke(e){for(var t=tanke_list.length;t--;)canvas_st.fillStyle=tanke_list[t].color,"init"===e&&getLocation(tanke_list[t]),canvas_st.fillRect(tanke_list[t].loc_x,tanke_list[t].loc_y,tanke_list[t].width,tanke_list[t].height),drawBlood(tanke_list[t]),drawEmitter(tanke_list[t])}function drawGift(){var e,t,i,l=gift_list,o=l.length;if(o>0)for(;o--;)e=l[o],canvas_st.fillStyle=e.appearance.color,i=e.appearance.stroke,i&&canvas_st.strokeRect(e.loc_x,e.loc_y,e.width,e.height),t=e.appearance.text,t&&(canvas_st.font="14px serif",canvas_st.textAlign="center",canvas_st.fillText(e.appearance.text,e.loc_x+e.width/2,e.loc_y+e.height/3*2))}function tankeFire(e){"unlimited"!==e.buller.num&&(e.buller.num<=1?(e.buller.type=0,e.buller.num="unlimited"):e.buller.num-=1);var t=buller_list_index.length;0===t?buller_list[buller_list.length]=getBuller(e.buller.type,e.emitter.x,e.emitter.y,e.tankeName,e.emitter.deration):(ind=buller_list_index[0],buller_list_index.shift(),buller_list[ind]=getBuller(e.buller.type,e.emitter.x,e.emitter.y,e.tankeName,e.emitter.deration))}function DestoryByBuller(e){buller_list[e]=null,buller_list_index[buller_list_index.length]=e}function bullerDestoryByBuller(e,t){buller_list[e].power>buller_list[t].power?(buller_list[e].power-=buller_list[t].power,DestoryByBuller(t)):buller_list[e].power<buller_list[t].power?(buller_list[t].power-=buller_list[e].power,DestoryByBuller(e)):(DestoryByBuller(e),DestoryByBuller(t))}function isIntersect(e,t,i,l,o,a,r,n){if(e>i){if(e>l)return!1}else if(i>e&&i>t)return!1;if(o>r){if(o>n)return!1}else if(r>o&&r>a)return!1;return!0}function o_bulller_val(e,t,i,l,o){switch(e.deration){case 0:o=e.loc_y+e.shootShap.hei,t-=e.shootShap.wid,i=e.loc_x;break;case 1:l-=e.shootShap.wid,i=e.loc_x+e.shootShap.hei,o=e.loc_y;break;case 2:i=e.loc_x+e.shootShap.wid,o=e.loc_y+e.shootShap.hei;break;case 3:i=e.loc_x+e.shootShap.hei,o=e.loc_y+e.shootShap.wid}return[t,i,l,o]}function checkbullerimpact(e,t){var i,l=buller_list.length,o=e.deration,a=e.shootShap.wid,r=e.shootShap.hei,n=e.loc_x,s=e.loc_y;if(2>l)return!1;switch(o){case 0:i=function(t){var i,l,o,c=t.loc_x,_=t.loc_y;return n-=a,o=o_bulller_val(t,c,i,_,l),c=o[0],i=o[1],_=o[2],l=o[3],isIntersect(n,n+a,c,i,s,s+r,_,l)?e.ownerName!==t.ownerName:!1};break;case 1:i=function(t){var i,l,o,c=t.loc_x,_=t.loc_y;return s-=a,o=o_bulller_val(t,c,i,_,l),c=o[0],i=o[1],_=o[2],l=o[3],isIntersect(n,n+r,c,i,s,s+a,_,l)?e.ownerName!==t.ownerName:!1};break;case 2:i=function(t){var i,l,o,c=t.loc_x,_=t.loc_y;return o=o_bulller_val(t,c,i,_,l),c=o[0],i=o[1],_=o[2],l=o[3],isIntersect(n,n+a,c,i,s,s+r,_,l)?e.ownerName!==t.ownerName:!1};break;case 3:i=function(t){var i,l,o,c=t.loc_x,_=t.loc_y;return o=o_bulller_val(t,c,i,_,l),c=o[0],i=o[1],_=o[2],l=o[3],isIntersect(n,n+r,c,i,s,s+a,_,l)?e.ownerName!==t.ownerName:!1}}for(;l--;)if(l!==t&&null!=buller_list[l]&&i(buller_list[l]))return bullerDestoryByBuller(t,l),!0;return!1}function destoryTanke(){cancelAnimationFrame(gameRun),document.onkeyup=null,alert("游戏结束")}function HitTanke(e,t){tanke_list[t].blood>buller_list[e].power?(tanke_list[t].blood-=buller_list[e].power,DestoryByBuller(e)):tanke_list[t].blood<buller_list[e].power?(buller_list[e].power-=tanke_list[t].blood,destoryTanke()):(DestoryByBuller(e),destoryTanke())}function o_tanke_val(e,t,i){switch(e.emitter.deration){case 0:t=e.loc_x+e.width,i=e.loc_y+e.height;break;case 1:t=e.loc_x+e.height,i=e.loc_y+e.width;break;case 2:t=e.loc_x+e.width,i=e.loc_y+e.height;break;case 3:t=e.loc_x+e.height,i=e.loc_y+e.width}return[t,i]}function isHitTanke(e,t){var i,l=tanke_list.length,o=(e.deration,e.shootShap.wid),a=e.shootShap.hei,r=e.loc_x,n=e.loc_y;switch(e.deration){case 0:i=function(e){var t,i,l,s=e.loc_x,c=e.loc_y;return r-=o,l=o_tanke_val(e,t,i),t=l[0],i=l[1],isIntersect(r,r+o,s,t,n,n+a,c,i)?!0:!1};break;case 1:i=function(e){var t,i,l,s=e.loc_x,c=e.loc_y;return n-=o,l=o_tanke_val(e,t,i),t=l[0],i=l[1],isIntersect(r,r+a,s,t,n,n+o,c,i)?!0:!1};break;case 2:i=function(e){var t,i,l,s=e.loc_x,c=e.loc_y;return l=o_tanke_val(e,t,i),t=l[0],i=l[1],isIntersect(r,r+o,s,t,n,n+a,c,i)?!0:!1};break;case 3:i=function(e){var t,i,l,s=e.loc_x,c=e.loc_y;return l=o_tanke_val(e,t,i),t=l[0],i=l[1],isIntersect(r,r+a,s,t,n,n+o,c,i)?!0:!1}}for(;l--;)if(tanke_list[l].tankeName!==e.ownerName&&i(tanke_list[l]))return HitTanke(t,l),!0;return!1}function overGameArea(e,t){var i=!1;switch(e.deration){case 0:e.loc_x-e.shootShap.wid<=0&&(i=!0);break;case 1:e.loc_y-e.shootShap.wid<=0&&(i=!0);break;case 2:e.loc_x+e.shootShap.wid>=canvas_wid&&(i=!0);break;case 3:e.loc_y+e.shootShap.wid>=canvas_hei&&(i=!0)}return i?(DestoryByBuller(t),!0):!1}function drawBuller(){var e,t=buller_list.length;for(canvas_st.fillStyle="#000";t--;)if(e=buller_list[t],null!=e){switch(e.deration){case 0:canvas_st.fillRect(e.loc_x-e.shootShap.wid,e.loc_y,e.shootShap.wid,e.shootShap.hei);break;case 1:canvas_st.fillRect(e.loc_x,e.loc_y-e.shootShap.hei,e.shootShap.wid,e.shootShap.hei);break;case 2:canvas_st.fillRect(e.loc_x,e.loc_y,e.shootShap.hei,e.shootShap.wid);break;case 3:canvas_st.fillRect(e.loc_x,e.loc_y,e.shootShap.hei,e.shootShap.wid)}if(!checkbullerimpact(e,t)&&!isHitTanke(e,t)&&!overGameArea(e,t))switch(e.deration){case 0:e.loc_x-=e.speed;break;case 1:e.loc_y-=e.speed;break;case 2:e.loc_x+=e.speed;break;case 3:e.loc_y+=e.speed}}}function needTime(){var e=(new Date).getTime(),t=2e3+Math.floor(5e3*Math.random());return e+t}function giftGenerate(){var e,t,i=gift_list.length,l=0;gift_max_len>i&&(l=(new Date).getTime(),l>=gift_timeOver&&(gift_timeOver=needTime(),e=equipment_list.length,e>1?(t=getRandom()%e,makeGift(equipment_list.slice(t,t+1)[0])):makeGift(equipment_list.slice(0,1)[0])))}function gameinit(){drawBG(),drawTanke("init"),document.onkeydown=function(e){e.stopPropagation(),(37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode||32===e.keyCode)&&e.preventDefault()},document.onkeyup=function(e){e.stopPropagation(),e.preventDefault(),console.log(e.keyCode),37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode?gamePlay(e.keyCode,tanke_obj1):96===e.keyCode&&tankeFire(tanke_obj1),65===e.keyCode||87===e.keyCode||68===e.keyCode||83===e.keyCode?gamePlay(e.keyCode,tanke_obj2):32===e.keyCode&&tankeFire(tanke_obj2)},requestAnimationFrame(gameRun)}function destoryGift(e){gift_list.splice(e,1)}function getEquipment(e){var t,i,l,o,a,r,n,s=e.loc_x,c=e.loc_y,_=gift_list.length,h=!1;if(_){switch(e.emitter.deration){case 0:s-=e.emitter.wid,t=e.loc_x+e.width,i=e.loc_y+e.height;break;case 1:c-=e.emitter.wid,i=e.loc_y+e.width,t=e.loc_x+e;break;case 2:t=e.loc_x+e.width+e.emitter.wid,i=e.loc_y+e.height;break;case 3:i=e.loc_y+e.width+e.emitter.wid,t=e.loc_x+e.height}for(;_--;)if(l=gift_list[_],o=l.loc_x,a=o+l.width,r=l.loc_y,n=r+l.height,isIntersect(s,t,o,a,c,i,r,n)){h=!0;break}h&&("buller"===l.giftType&&(e.buller.type=l.powerType,e.buller.num=l.bullerNum),destoryGift(_))}}function gameRun(){drwaGame(),requestAnimationFrame(gameRun)}function gamePlay(e,t){switch(e){case 65:case 37:t.loc_x-=t.speed,t.emitter.deration=0;break;case 87:case 38:t.loc_y-=t.speed,t.emitter.deration=1;break;case 68:case 39:t.loc_x+=t.speed,t.emitter.deration=2;break;case 83:case 40:t.loc_y+=t.speed,t.emitter.deration=3}getEquipment(t),checkArea(t)}function checkArea(e){e.loc_x<0?e.loc_x=0:e.loc_x+e.width>canvas_wid&&(e.loc_x=canvas_wid-e.width),e.loc_y<0?e.loc_y=0:e.loc_y+e.height>canvas_hei&&(e.loc_y=canvas_hei-e.height)}function drwaGame(){canvas_st.clearRect(0,0,canvas_wid,canvas_hei),drawBG(),drawTanke(),drawBuller(),giftGenerate(),drawGift()}window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||windooCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame;var canvas_el=document.getElementById("game"),canvas_st=canvas_el.getContext("2d"),canvas_wid=canvas_el.offsetWidth,canvas_hei=canvas_el.offsetHeight,equipment_list=[],gift_list=[],gift_timeOver=needTime(),gift_max_len=10,tanke_list=[],buller_list=[],buller_list_index=[],tanke_obj1,tanke_obj2;equipment_list[equipment_list.length]="gift_buller_power1",equipment_list[equipment_list.length]="gift_buller_power2",equipment_list[equipment_list.length]="gift_buller_power3";var buller_superClass=new buller;tanke_obj1=new tanke,tanke_obj2=new tanke,tanke_obj2.color="#f60",tanke_obj2.emitter.color="#f60",tanke_obj2.buller.type=2,window.tankeGame={author:"郑雄升",buildTime:"2017-9-10"},gameinit();